#!/bin/sh

set -euf

DIR=${1:-'.'}
CMD=${2:-}

SCM=

if [ -d "$DIR/.git" ]; then
    #
    # Locate the closest annotated tag
    #
    REVISION="$(git describe --abbrev=0 --tags 2>/dev/null || echo unknown)"

    #
    # Determine if we are a development branch, if so then append the
    # short SHA1.
    #
    EXACTLY="$(git describe --abbrev=0 --tags --exact-match 2>/dev/null || echo)"

    if test -z "$EXACTLY"; then
        REVISION="${REVISION}_rev-$(git rev-parse --verify --short HEAD)"
        SCM="_rev-$(git rev-parse --verify --short HEAD)"
    fi
elif [ -n "${GITHUB_SHA:-}" ]; then
    SHORT_SHA_REVISION="$(echo "$GITHUB_SHA" | cut -b 1-8)"

    VERSION=$(cat "$DIR/AC_VERSION" 2>/dev/null)
    REVISION="${VERSION}_rev-${SHORT_SHA_REVISION}"
    SCM="_rev-${SHORT_SHA_REVISION}"
else
    REVISION="$(cat "$DIR/AC_VERSION" 2>/dev/null)"
fi

case $CMD in
    'scm')
        echo "$SCM"
        ;;
    'quoted')
        echo \""$REVISION"\"
        ;;
    *)
        echo "$REVISION"
        ;;
esac
